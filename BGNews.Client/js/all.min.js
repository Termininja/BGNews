var newsApp=angular.module("newsApp",["ngRoute","ui.bootstrap","ngAnimate"]);!function(){"use strict";newsApp.config(function(e,t){t.html5Mode(!0),e.when("/",{title:"Home",templateUrl:"templates/collection.html",controller:"PostsController"}).when("/category/:categoryName",{templateUrl:"templates/collection.html",controller:"PostsController"}).when("/search/:word",{title:"Search",templateUrl:"templates/collection.html",controller:"SearchController"}).when("/tags/:tag",{templateUrl:"templates/collection.html",controller:"TagsController"}).when("/post/:postId",{templateUrl:"templates/post.html",controller:"PostController"}).when("/login",{title:"Login",templateUrl:"templates/login.html"}).when("/signup",{title:"Signup",templateUrl:"templates/signup.html"}).when("/users",{title:"Users",templateUrl:"templates/collection.html",controller:"UsersController"}).when("/profile",{title:"Profile",templateUrl:"templates/profile.html",controller:"ProfileController"}).when("/users/:username",{templateUrl:"templates/user.html",controller:"UserController"}).when("/new-post",{title:"New Post",templateUrl:"templates/add-post.html",controller:"AddPostController"}).when("/help",{title:"Help",templateUrl:"templates/help.html"}).otherwise({redirectTo:"/"})}).constant("ITEMS_PER_PAGE",6).constant("LEVEL_OF_NESTED_COMMENTS",3).constant("DEFAULT_PROFILE_IMAGE","http://s15.postimg.org/j9x15yxxj/user.jpg").constant("SCHEME_COLORS",["Black","Brown","Gray","Red","Turquoise"]).constant("CATEGORIES",{Business:["Finance","Energy","Industry","Properties","Tourism"],Politics:["Diplomacy","Defense","Bulgaria in EU","Domestic"],World:["EU","Southeast Europe","Russia","Ukraine","International Business"],Society:["Environment","Education","Culture","Health","Incidents"],Sports:["Sports"],Crime:["Crime"]}).run(["$rootScope",function(e){Parse.initialize("U3XywIHqzfU4KD8FEV57PRmMZPpmuDOwflN6itSy","PA0TnuPtd3ktVSscE4BECVlYr7y7TPNRfxGRe5eb"),e.Post=Parse.Object.extend("Post"),e.Comment=Parse.Object.extend("Comment"),e.Category=Parse.Object.extend("Category"),e.Tag=Parse.Object.extend("Tag"),e.$on("$routeChangeSuccess",function(t,l){e.title=l.title})}])}();
!function(){"use strict";newsApp.controller("AddPostController",function(n,o,r){n.currentUser&&"Administrator"===n.currentUser.role?(o.isAdmin=!0,o.addPost=function(n){r.addPost(n)},o.cancel=function(){n.reloadTo("/")}):(o.isAdmin=!1,n.reloadTo("/"))})}();
!function(){"use strict";newsApp.controller("PageController",function(e,r,s,t,c,n,o){c.navigateTo=function(e){r.path(e),c.$apply()},c.reloadTo=function(e){s.location.assign(e)},c.login=function(e){Parse.User.logIn(e.username,e.password,{success:function(){c.statusUpdate(),c.reloadTo("/")},error:function(e,r){console.log("Error: "+r.code+" "+r.message)}})},c.signup=function(e){var r="2IPQes1NcD",s=new Parse.User;s.set("username",e.username),s.set("password",e.password),s.set("email",e.email),s.set("colorScheme","Black"),s.set("role",{__type:"Pointer",className:"_Role",objectId:r}),s.signUp(null,{success:function(){c.reloadTo("/profile")},error:function(e,r){console.log("Error: "+r.code+" "+r.message)}})},c.logout=function(){Parse.User.logOut(),c.statusUpdate(),c.reloadTo("/")},c.profileImageUpdate=function(){c.currentUser.showImage&&c.currentUser.showImage!=c.currentUser.image?c.currentUser.showImage=c.currentUser.image:c.currentUser.image?c.currentUser.showImage=c.currentUser.image.url():c.currentUser.showImage=o},c.statusUpdate=function(){c.currentUser=Parse.User.current(),c.currentUser?n.getUserRole().then(function(e){c.currentUser.role=e,c.currentUser.username=c.currentUser.get("username"),c.currentUser.email=c.currentUser.get("email"),c.currentUser.firstName=c.currentUser.get("firstName"),c.currentUser.lastName=c.currentUser.get("lastName"),c.currentUser.website=c.currentUser.get("website"),c.currentUser.gender=c.currentUser.get("gender"),c.currentUser.aboutMe=c.currentUser.get("aboutMe"),c.currentUser.colorScheme=c.currentUser.get("colorScheme"),c.currentUser.image=c.currentUser.get("image"),c.profileImageUpdate(),c.colorSchemeUpdate()}):c.colorSchemeUpdate()},c.colorSchemeUpdate=function(){switch(c.currentUser?c.currentUser.colorScheme:void 0){default:c.csHtml="cs-html-black";break;case"Brown":c.csHtml="cs-html-brown";break;case"Gray":c.csHtml="cs-html-gray";break;case"Red":c.csHtml="cs-html-red";break;case"Turquoise":c.csHtml="cs-html-turquoise"}},c.statusUpdate()})}();
!function(){"use strict";newsApp.controller("PostController",function(t,o,e,n){t.replyToPost=!0,t.tabPostsShow=[!0,!1,!1],t.getAllComments=function(){n.getComments(o.postId).then(function(o){t.comments=o})},t.replyTo=function(o){function e(t){$.map(t.comments,function(t){t.showReply=t.id===o,e(t)})}t.replyToCommentId=o,t.replyToPost=!1,e(t)},t.addComment=function(e){n.addComment(e,o.postId,t.replyToCommentId).then(function(o){o&&(t.getPost(),t.getAllComments(),t.replyToPost=!0,t.replyToCommentId=void 0,t.newComment="")})},t.deleteComment=function(o){n.deleteComment(o).then(function(o){o&&t.getAllComments()})},t.getTabPosts=function(){n.getRecentPosts(5).then(function(o){t.recentPosts=o,n.getPopularPosts(4).then(function(e){n.getRandomPosts(4).then(function(n){t.tabPosts=[o.slice(0,-1),e,n]})})})},t.toggleTab=function(o){t.tabPostsShow=new Array(3),t.tabPostsShow[o]=!0},t.getPost=function(){n.getPost(o.postId).then(function(s){e.title=s.title,t.post=s,t.getAllComments(),n.getRecentComments(5).then(function(o){t.recentComments=o}),n.getRelatedPosts(o.postId,t.post.tags,5).then(function(o){t.relatedPosts=o})})},t.getPost(),t.getTabPosts()})}();
!function(){"use strict";newsApp.controller("PostsController",function(e,t,o,r,n,a){e.itemsPerPage=a,e.isUser=!1,e.isPost=!0,e.currentPage=1,e.pages=5,e.getPage=function(){var s=(e.currentPage-1)*a,c=t.categoryName;c?(c=c.replace(/_/g," "),e.isHome=!0):e.isHome=!1;var i=function(){var e;return c&&$.each(n,function(t){return t.toLowerCase()===c.toLowerCase()?(e=t,!1):void $.each(n[t],function(o){var r=n[t][o];return r.toLowerCase()===c.toLowerCase()?(e=r,!1):void 0})}),e};c=i(),r.getCategory(s,a,c).then(function(t){e.collection=t.posts,e.totalItems=t.count,c&&(o.title=c)})},e.getPage()})}();
!function(){"use strict";newsApp.controller("ProfileController",function(e,o,r,l){o.currentUser?(e.isLogged=!0,e.hello="Hello "+o.currentUser.username,e.colors=l,e.updateProfile=function(e){r.updateProfile(e)},e.deleteProfile=function(){r.deleteProfile()}):(e.isLogged=!1,o.reloadTo("/"))})}();
!function(){"use strict";newsApp.controller("SearchController",function(e,t,n,o){e.itemsPerPage=o,e.isPost=!0,e.isUser=!1,e.currentPage=1,e.pages=5,e.getPage=function(){var r=(e.currentPage-1)*o;n.search(r,o,t.word).then(function(t){e.collection=t.posts,e.totalItems=t.count}),e.isHome=!0},e.getPage()})}();
!function(){"use strict";newsApp.controller("TagsController",function(t,e,n,o,g){n.title="Tag "+e.tag,t.itemsPerPage=g,t.isPost=!0,t.isUser=!1,t.currentPage=1,t.pages=5,t.getPage=function(){var n=(t.currentPage-1)*g;o.getByTag(n,g,e.tag).then(function(e){t.collection=e.posts,t.totalItems=e.count}),t.isHome=!0},t.getPage()})}();
!function(){"use strict";newsApp.controller("UserController",function(e,n,t,r){t.title=n.username,r.getUser(n.username).then(function(n){e.user=n})})}();
!function(){"use strict";newsApp.controller("UsersController",function(e,t,s){e.itemsPerPage=s,e.isPost=!1,e.isUser=!0,e.currentPage=1,e.pages=5,e.getPage=function(){var n=(e.currentPage-1)*s;t.getUsers(n,s).then(function(t){e.collection=t.users,e.totalItems=t.count}),e.isHome=!0},e.getPage()})}();
!function(){"use strict";newsApp.directive("addComment",function(){return{restrict:"A",templateUrl:"/templates/directives/add-comment.html",replace:!1}})}();
!function(){"use strict";newsApp.directive("postThumbnail",function(){return{restrict:"A",templateUrl:"/templates/directives/post-thumbnail.html",replace:!1}})}();
!function(){"use strict";newsApp.directive("userThumbnail",function(){return{restrict:"A",templateUrl:"/templates/directives/user-thumbnail.html",replace:!1}})}();
!function(){"use strict";newsApp.factory("postData",function(e,t,r,n,o){return{getCategory:function(o,s,c){function u(t){var n=new Parse.Query(e.Post);a&&n.containedIn("category",t),n.count({success:function(n){var c=new Parse.Query(e.Post).skip(o).limit(s).descending("createdAt");a&&c.containedIn("category",t),c.include("user","category"),c.find({success:function(e){var t=[];e.forEach(function(e){t.push({id:e.id,createdAt:e.createdAt,user:e.get("user").get("username"),title:e.get("title"),image:e.get("image"),category:e.get("category").get("name"),content:r.trustAsHtml(e.get("content"))})}),i.resolve({count:n,posts:t})},error:function(e){i.reject(e)}})},error:function(e){i.reject(e)}})}var a;$.each(n,function(e){return c===e&&n[e].length>1?(c=e,a=n[e],!1):void 0}),!a&&c&&(a=[c]);var i=t.defer();if(a){var f=new Parse.Query(e.Category);f.containedIn("name",a),f.find({success:function(e){var t=[];e.forEach(function(e){t.push({__type:"Pointer",className:"Category",objectId:e.id})}),u(t)}})}else u(null);return i.promise},getPost:function(n){var o=t.defer(),s=new Parse.Query(e.Post);return s.include("user","category","tags"),s.get(n,{success:function(t){var s=t.get("image"),c=s.replace("_big_","_verybig_"),u=t.get("category").get("name"),a=function(e,t){var r=new Image;r.onload=function(){t(!0)},r.onerror=function(){t(!1)},r.src=e};a(c,function(a){var i=new Parse.Query(e.Comment);i.equalTo("post",{__type:"Pointer",className:"Post",objectId:n}),i.count({success:function(e){o.resolve({comments:e,createdAt:t.createdAt,user:t.get("user").get("username"),title:t.get("title"),image:a?c:s,category:u,categoryLink:u.toLowerCase().replace(/ /g,"_"),content:r.trustAsHtml(t.get("content")),tags:$.map(t.get("tags"),function(e){return e.get("name")})})},error:function(e){o.reject(e)}})})},error:function(e){o.reject(e)}}),o.promise},getByTag:function(n,o,s){var c=t.defer(),u=new Parse.Query(e.Tag);return u.equalTo("name",s),u.first({success:function(t){var s=new Parse.Query(e.Post);s.equalTo("tags",{__type:"Pointer",className:"Tag",objectId:t.id}),s.count({success:function(s){var u=new Parse.Query(e.Post).skip(n).limit(o).descending("createdAt");u.equalTo("tags",{__type:"Pointer",className:"Tag",objectId:t.id}),u.include("user","category"),u.find({success:function(e){var t=[];e.forEach(function(e){t.push({id:e.id,createdAt:e.createdAt,user:e.get("user").get("username"),title:e.get("title"),image:e.get("image"),category:e.get("category").get("name"),content:r.trustAsHtml(e.get("content"))})}),c.resolve({count:s,posts:t})},error:function(e){c.reject(e)}})},error:function(e){c.reject(e)}})},error:function(e){c.reject(e)}}),c.promise},getComments:function(r){var n=t.defer(),s=new Parse.Query(e.Comment);return s.include("user","post","comment"),s.equalTo("post",{__type:"Pointer",className:"Post",objectId:r}),s.find({success:function(e){function t(e){var n=[];return r.forEach(function(r){r.commentId===e&&(r.comments=t(r.id),n.push(r))}),n}var r=[];e.forEach(function(e){var t=e.get("user").get("image"),n=e.get("comment");r.push({id:e.id,createdAt:e.createdAt,content:e.get("content"),username:e.get("user").get("username"),commentId:n?n.id:void 0,avatar:t?t.url():o})});var s=[];r.forEach(function(e){e.commentId||(e.comments=t(e.id),s.push(e))}),n.resolve(s)},error:function(e){n.reject(e)}}),n.promise},addPost:function(t){var r=new Parse.Query(e.Category);r.equalTo("name",t.category),r.first({success:function(r){if(r.get("name")===t.category){var n=new e.Post;n.set("user",Parse.User.current()),n.set("category",r),n.set("title",t.title),n.set("image",t.image),n.set("content",t.content),n.set("tags",[]),n.save({success:function(){e.reloadTo("/")}})}}})},addComment:function(r,n,o){var s=t.defer(),c=new e.Comment;return c.set("user",Parse.User.current()),c.set("content",r),c.set("post",new e.Post({objectId:n})),o&&c.set("comment",new e.Comment({objectId:o})),c.save({success:function(){s.resolve(!0)},error:function(e,t){s.reject(t)}}),s.promise},deleteComment:function(r){var n=t.defer(),o=new Parse.Query(e.Comment);return o.get(r,{success:function(e){e.destroy({success:function(){n.resolve(!0),console.info("comment deleted")},error:function(e){n.reject(e)}})},error:function(e,t){n.reject(t)}}),n.promise},search:function(n,o,s){var c=t.defer(),u=new Parse.Query(e.Post).limit(1e3);return u.matches("content",".*"+s+".*"),u.count({success:function(t){var u=new Parse.Query(e.Post).skip(n).limit(o).descending("createdAt");u.matches("content",".*"+s+".*"),u.include("user","category"),u.find({success:function(e){var n=[];e.forEach(function(e){n.push({id:e.id,createdAt:e.createdAt,user:e.get("user").get("username"),title:e.get("title"),image:e.get("image"),category:e.get("category").get("name"),content:r.trustAsHtml(e.get("content"))})}),c.resolve({count:t,posts:n})},error:function(e){c.reject(e)}})},error:function(e){c.reject(e)}}),c.promise},getRecentComments:function(r){var n=t.defer(),o=new Parse.Query(e.Comment).limit(r).descending("createdAt");return o.include("user","post"),o.find({success:function(e){var t=[];e.forEach(function(e){t.push({id:e.id,createdAt:e.createdAt,user:e.get("user").get("username"),postId:e.get("post").id,content:e.get("content")})}),n.resolve(t)},error:function(e){n.reject(e)}}),n.promise},getRecentPosts:function(r){var n=t.defer(),s=new Parse.Query(e.Post).limit(r).descending("createdAt");return s.include("user","post"),s.find({success:function(e){var t=[];e.forEach(function(e){var r=e.get("user").get("image");t.push({id:e.id,createdAt:e.createdAt,title:e.get("title"),user:e.get("user").get("username"),avatar:r?r.url():o})}),n.resolve(t)},error:function(e){n.reject(e)}}),n.promise},getPopularPosts:function(r){var n=t.defer(),s=new Parse.Query(e.Comment).limit(1e3);return s.include("user","post"),s.find({success:function(t){var s={};$.map(t,function(e){var t=e.get("post").id;t in s?s[t]++:s[t]=1});var c=[];$.each(s,function(e){c.push({postId:e,count:s[e]})}),c.sort(function(e,t){return t.count-e.count});var u=c.slice(0,r),a=[];if(u.forEach(function(t){var r=new Parse.Query(e.Post).equalTo("objectId",t.postId);a.push(r)}),a.length>0){var i=Parse.Query.or.apply(this,a);i.include("user","post"),i.find({success:function(e){var t=[];u.forEach(function(r){e.forEach(function(e){if(r.postId===e.id){var n=e.get("user").get("image");return void t.push({id:e.id,createdAt:e.createdAt,title:e.get("title"),user:e.get("user").get("username"),avatar:n?n.url():o})}})}),n.resolve(t)},error:function(e){n.reject(e)}})}else n.resolve([])},error:function(e){n.reject(e)}}),n.promise},getRandomPosts:function(r){function n(t){new Parse.Query(e.Post).limit(1e3).skip(t).count().then(function(c){if(1e3!=c){var u=t+c,a=new Parse.Query(e.Post);return a.skip(Math.floor(Math.random()*u+1)).limit(r),a.include("user","post"),void a.find({success:function(e){var t=[];e.forEach(function(e){var r=e.get("user").get("image");t.push({id:e.id,createdAt:e.createdAt,title:e.get("title"),user:e.get("user").get("username"),avatar:r?r.url():o})}),s.resolve(t)},error:function(e){s.reject(e)}})}n(t+c)})}var s=t.defer();return n(0),s.promise},getRelatedPosts:function(r,n,s){var c=t.defer(),u=[];n.forEach(function(t){var r=new Parse.Query(e.Tag).equalTo("name",t);u.push(r)});var a=Parse.Query.or.apply(this,u);return a.find({success:function(t){var n=[];t.forEach(function(t){var r=new Parse.Query(e.Post);r.equalTo("tags",{__type:"Pointer",className:"Tag",objectId:t.id}),n.push(r)});var u=Parse.Query.or.apply(this,n).limit(s);u.notEqualTo("objectId",r),u.include("user"),u.find({success:function(e){var t=[];e.forEach(function(e){var r=e.get("user").get("image");t.push({id:e.id,createdAt:e.createdAt,title:e.get("title"),user:e.get("user").get("username"),avatar:r?r.url():o})}),c.resolve(t)},error:function(e){c.reject(e)}})},error:function(e){c.reject(e)}}),c.promise}}})}();
!function(){"use strict";newsApp.factory("userData",function(e,r,t,s){return{getUsers:function(r,t){var n=e.defer(),o=new Parse.Query(Parse.User);return o.count({success:function(e){var o=new Parse.Query(Parse.User).skip(r).limit(t).descending("createdAt");o.include("role"),o.find({success:function(r){var t=[];r.forEach(function(e){var r=e.get("image");t.push({username:e.get("username"),createdAt:e.createdAt,avatar:r?r.url():s,gender:e.get("gender"),aboutMe:e.get("aboutMe"),role:e.get("role").get("name")})}),n.resolve({count:e,users:t})},error:function(e){n.reject(e)}})},error:function(e){n.reject(e)}}),n.promise},getUser:function(r){var t=e.defer(),n=new Parse.Query(Parse.User);return n.equalTo("username",r),n.include("role"),n.first({success:function(e){var r=e.get("image");t.resolve({username:e.get("username"),createdAt:e.createdAt,image:r?r.url():s,email:e.get("email"),firstName:e.get("firstName"),lastName:e.get("lastName"),website:e.get("website"),gender:e.get("gender"),aboutMe:e.get("aboutMe"),colorScheme:e.get("colorScheme"),role:e.get("role").get("name")})},error:function(e){t.reject(e)}}),t.promise},getUserRole:function(){var r=e.defer();return t.currentUser.get("role").fetch({success:function(e){r.resolve(e.get("name"))},error:function(e){r.reject(e)}}),r.promise},updateProfile:function(e){if(e.set("firstName",e.firstName),e.set("lastName",e.lastName),e.set("website",e.website),e.set("gender",e.gender),e.set("aboutMe",e.aboutMe),e.set("colorScheme",e.colorScheme),e.showImage.length>1e3){var r=new Parse.File(e.id+".jpg",{base64:e.image});r.save().then(function(r){e.set("image",r),e.save({success:function(){t.statusUpdate(),t.statusUpdate()},error:function(e,r){console.info(r)}})})}else e.save({success:function(){t.statusUpdate(),t.statusUpdate()},error:function(e){console.info(e)}})},deleteProfile:function(){confirm("Your profile will be permanently deleted and cannot be recovered. Are you sure?")?Parse.User.current().destroy({success:function(){console.info("deleted"),t.logout()},error:function(e){console.info(e)}}):console.log("not deleted")}}})}();
!function(){"use strict";newsApp.directive("fileReader",function(e,n){return{restrict:"A",require:"ngModel",link:function(t,r,i,a){r.bind("change",function(t){function r(){var n=e.defer(),r=new FileReader;return r.onload=function(e){n.resolve(e.target.result)},r.readAsDataURL(t.target.files[0]),n.promise}r().then(function(e){a.$setViewValue(e),n.profileImageUpdate()})})}}})}();
!function(){"use strict";newsApp.directive("showReply",function(e){return{restrict:"A",link:function(n){n.showReplyLink=++n.commentLevel<e}}})}();