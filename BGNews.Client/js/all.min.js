var newsApp=angular.module("newsApp",["ngRoute","ngAnimate","ui.bootstrap"]);!function(){"use strict";newsApp.config(function(e,t){t.html5Mode(!0),e.when("/",{title:"Home",templateUrl:"templates/collection.html",controller:"PostsController"}).when("/category/:categoryName",{templateUrl:"templates/collection.html",controller:"PostsController"}).when("/search/:word",{title:"Search",templateUrl:"templates/collection.html",controller:"SearchController"}).when("/tags/:tag",{templateUrl:"templates/collection.html",controller:"TagsController"}).when("/post/:postId",{templateUrl:"templates/post.html",controller:"PostController"}).when("/login",{title:"Login",templateUrl:"templates/login.html"}).when("/signup",{title:"Signup",templateUrl:"templates/signup.html"}).when("/users",{title:"Users",templateUrl:"templates/collection.html",controller:"UsersController"}).when("/profile",{title:"Profile",templateUrl:"templates/profile.html",controller:"ProfileController"}).when("/users/:username",{templateUrl:"templates/user.html",controller:"UserController"}).when("/new-post",{title:"New Post",templateUrl:"templates/add-post.html",controller:"AddPostController"}).when("/help",{title:"Help",templateUrl:"templates/help.html"}).otherwise({redirectTo:"/"})}).constant("ITEMS_PER_PAGE",12).constant("MAX_PAGINATION_PAGES",5).constant("LEVEL_OF_NESTED_COMMENTS",3).constant("DEFAULT_PROFILE_IMAGE","/images/user.jpg").constant("SCHEME_COLORS",["Black","Brown","Gray","Red","Turquoise"]).constant("CATEGORIES",{Business:["Finance","Energy","Industry","Properties","Tourism"],Politics:["Diplomacy","Defense","Bulgaria in EU","Domestic"],World:["EU","Southeast Europe","Russia","Ukraine","International Business"],Society:["Environment","Education","Culture","Health","Incidents"],Sports:["Sports"],Crime:["Crime"]}).run(["$rootScope",function(e){Parse.initialize("U3XywIHqzfU4KD8FEV57PRmMZPpmuDOwflN6itSy","PA0TnuPtd3ktVSscE4BECVlYr7y7TPNRfxGRe5eb"),e.Post=Parse.Object.extend("Post"),e.Comment=Parse.Object.extend("Comment"),e.Category=Parse.Object.extend("Category"),e.Tag=Parse.Object.extend("Tag"),e.$on("$routeChangeSuccess",function(t,l){e.title=l.title})}])}();
!function(){"use strict";newsApp.controller("AddPostController",function(t,n,o){t.getActiveState(),t.currentUser&&"Administrator"===t.currentUser.role?(n.isAdmin=!0,n.addPost=function(t){o.addPost(t)},n.cancel=function(){t.reloadTo("/")}):(n.isAdmin=!1,t.reloadTo("/"))})}();
!function(){"use strict";newsApp.controller("PageController",function(e,r,s,t,c,a,o,n,i){c.navigateTo=function(e){r.path(e),c.$apply()},c.reloadTo=function(e){s.location.assign(e)},c.login=function(e){Parse.User.logIn(e.username,e.password,{success:function(){c.statusUpdate(),c.reloadTo("/")},error:function(e,r){console.log("Error: "+r.code+" "+r.message)}})},c.signup=function(e){var r="2IPQes1NcD",s=new Parse.User;s.set("username",e.username),s.set("password",e.password),s.set("email",e.email),s.set("colorScheme","Black"),s.set("role",{__type:"Pointer",className:"_Role",objectId:r}),s.signUp(null,{success:function(){c.reloadTo("/profile")},error:function(e,r){console.log("Error: "+r.code+" "+r.message)}})},c.logout=function(){Parse.User.logOut(),c.statusUpdate(),c.reloadTo("/")},c.profileImageUpdate=function(){c.currentUser.showImage&&c.currentUser.showImage!=c.currentUser.image?c.currentUser.showImage=c.currentUser.image:c.currentUser.image?c.currentUser.showImage=c.currentUser.image.url():c.currentUser.showImage=i},c.getActiveState=function(){switch($(".navbar-nav").children().removeClass("active"),r.path()){case"/":$(".navbar-nav li:first()").addClass("active");break;case"/category/business":case"/category/finance":case"/category/energy":case"/category/industry":case"/category/properties":case"/category/tourism":$(".navbar-nav li:nth-child(2)").addClass("active");break;case"/category/politics":case"/category/diplomacy":case"/category/defense":case"/category/bulgaria_in_eu":case"/category/domestic":$(".navbar-nav li:nth-child(3)").addClass("active");break;case"/category/world":case"/category/eu":case"/category/southeast_europe":case"/category/russia":case"/category/ukraine":case"/category/international_business":$(".navbar-nav li:nth-child(4)").addClass("active");break;case"/category/society":case"/category/environment":case"/category/education":case"/category/culture":case"/category/health":case"/category/incidents":$(".navbar-nav li:nth-child(5)").addClass("active");break;case"/category/sports":$(".navbar-nav li:nth-last-child(2)").addClass("active");break;case"/category/crime":$(".navbar-nav li:last()").addClass("active")}},c.statusUpdate=function(){c.currentUser=Parse.User.current(),c.currentUser?o.getUserRole().then(function(e){c.currentUser.role=e,c.currentUser.username=c.currentUser.get("username"),c.currentUser.email=c.currentUser.get("email"),c.currentUser.firstName=c.currentUser.get("firstName"),c.currentUser.lastName=c.currentUser.get("lastName"),c.currentUser.website=c.currentUser.get("website"),c.currentUser.gender=c.currentUser.get("gender"),c.currentUser.aboutMe=c.currentUser.get("aboutMe"),c.currentUser.colorScheme=c.currentUser.get("colorScheme"),c.currentUser.image=c.currentUser.get("image"),c.profileImageUpdate(),c.colorSchemeUpdate()}):c.colorSchemeUpdate()},c.colorSchemeUpdate=function(){switch(c.csLeftArrow="cs-left-arrow-white",c.csRightArrow="cs-right-arrow-white",c.currentUser?c.currentUser.colorScheme:void 0){default:c.csHtml="cs-html-black",c.csFooter="cs-footer-black",c.csSearch="cs-search-black",c.csDropdown="cs-dropdown-black";break;case"Brown":c.csHtml="cs-html-brown",c.csFooter="cs-footer-brown",c.csSearch="cs-search-brown",c.csDropdown="cs-dropdown-brown";break;case"Gray":c.csHtml="cs-html-gray",c.csFooter="cs-footer-gray",c.csSearch="cs-search-gray",c.csDropdown="cs-dropdown-gray",c.csLeftArrow="cs-left-arrow-black",c.csRightArrow="cs-right-arrow-black";break;case"Red":c.csHtml="cs-html-red",c.csFooter="cs-footer-red",c.csSearch="cs-search-red",c.csDropdown="cs-dropdown-red";break;case"Turquoise":c.csHtml="cs-html-turquoise",c.csFooter="cs-footer-turquoise",c.csSearch="cs-search-turquoise",c.csDropdown="cs-dropdown-turquoise"}},c.getPostsInFooter=function(){a.getRecentPosts(5).then(function(e){c.recentPosts=e}),a.getRecentComments(5).then(function(e){c.recentComments=e}),a.getPopularPosts(5).then(function(e){c.popularPosts=e})},c.categoryToLink=function(e){return e.toLowerCase().replace(/ /g,"_")},c.categories=n,c.statusUpdate(),c.getActiveState(),c.getPostsInFooter(),$(".navbar-nav > li.dropdown").hover(function(){$("ul.dropdown-menu",this).stop(!0,!0).slideDown("fast"),$(this).addClass("open")},function(){$("ul.dropdown-menu",this).stop(!0,!0).slideUp("fast"),$(this).removeClass("open")})})}();
!function(){"use strict";newsApp.controller("PostController",function(t,o,e,n){t.replyToPost=!0,t.tabPostsShow=[!0,!1,!1],t.getAllComments=function(){n.getComments(o.postId).then(function(o){t.comments=o})},t.replyTo=function(o){function e(t){$.map(t.comments,function(t){t.showReply=t.id===o,e(t)})}t.replyToCommentId=o,t.replyToPost=!1,e(t)},t.addComment=function(e){n.addComment(e,o.postId,t.replyToCommentId).then(function(o){o&&(t.getPost(),t.getAllComments(),t.replyToPost=!0,t.replyToCommentId=void 0,t.newComment="")})},t.deleteComment=function(o){n.deleteComment(o).then(function(o){o&&t.getAllComments()})},t.getTabPosts=function(){e.getPostsInFooter(),n.getRandomPosts(4).then(function(o){t.tabPosts=[e.recentPosts.slice(0,-1),e.popularPosts.slice(0,-1),o]})},t.toggleTab=function(o){t.tabPostsShow=new Array(3),t.tabPostsShow[o]=!0},t.getPost=function(){e.getActiveState(),n.getPost(o.postId).then(function(s){e.title=s.title,t.post=s,t.getAllComments(),n.getRelatedPosts(o.postId,t.post.tags,5).then(function(o){t.relatedPosts=o})})},t.getPost(),t.getTabPosts()})}();
!function(){"use strict";newsApp.controller("PostsController",function(e,t,o,r,n,a,s,c){e.itemsPerPage=c,e.pages=s,e.isUser=!1,e.isPost=!0,e.getPage=function(r){t.getActiveState(),e.currentPage=r?r:e.currentPage;var s=(r-1)*c,i=o.categoryName;i?(i=i.replace(/_/g," "),e.isHome=!0):e.isHome=!1;var u=function(){var e;return i&&$.each(a,function(t){return t.toLowerCase()===i.toLowerCase()?(e=t,!1):void $.each(a[t],function(o){var r=a[t][o];return r.toLowerCase()===i.toLowerCase()?(e=r,!1):void 0})}),e};i=u(),n.getCategory(s,c,i).then(function(o){e.collection=o.posts,e.totalItems=o.count,i&&(t.title=i)})},e.getPage(1)})}();
!function(){"use strict";newsApp.controller("ProfileController",function(e,o,r,t){o.getActiveState(),o.currentUser?(e.isLogged=!0,e.hello="Hello "+o.currentUser.username,e.colors=t,e.updateProfile=function(e){r.updateProfile(e)},e.deleteProfile=function(){r.deleteProfile()}):(e.isLogged=!1,o.reloadTo("/"))})}();
!function(){"use strict";newsApp.controller("SearchController",function(e,t,n,r,o,c){e.itemsPerPage=c,e.pages=o,e.isPost=!0,e.isUser=!1,e.getPage=function(o){t.getActiveState(),e.currentPage=o?o:e.currentPage;var s=(e.currentPage-1)*c;r.search(s,c,n.word).then(function(t){e.collection=t.posts,e.totalItems=t.count}),e.isHome=!0},e.getPage(1)})}();
!function(){"use strict";newsApp.controller("TagsController",function(t,e,n,g,a,o){n.title="Tag "+e.tag,t.itemsPerPage=o,t.pages=a,t.isPost=!0,t.isUser=!1,t.getPage=function(a){n.getActiveState(),t.currentPage=a?a:t.currentPage;var r=(t.currentPage-1)*o;g.getByTag(r,o,e.tag).then(function(e){t.collection=e.posts,t.totalItems=e.count}),t.isHome=!0},t.getPage(1)})}();
!function(){"use strict";newsApp.controller("UserController",function(e,t,n,r){n.title=t.username,n.getActiveState(),r.getUser(t.username).then(function(t){e.user=t})})}();
!function(){"use strict";newsApp.controller("UsersController",function(e,t,n,r,s){e.itemsPerPage=s,e.pages=r,e.isPost=!1,e.isUser=!0,e.getPage=function(r){t.getActiveState(),e.currentPage=r?r:e.currentPage;var o=(e.currentPage-1)*s;n.getUsers(o,s).then(function(t){e.collection=t.users,e.totalItems=t.count}),e.isHome=!0},e.getPage(1)})}();
!function(){"use strict";newsApp.directive("addComment",function(){return{restrict:"A",templateUrl:"/templates/directives/add-comment.html",replace:!1}})}();
!function(){"use strict";newsApp.directive("postThumbnail",function(){return{restrict:"A",templateUrl:"/templates/directives/post-thumbnail.html",replace:!1}})}();
!function(){"use strict";newsApp.directive("userThumbnail",function(){return{restrict:"A",templateUrl:"/templates/directives/user-thumbnail.html",replace:!1}})}();
!function(){"use strict";newsApp.factory("postData",function(e,t,r,n,o){return{getCategory:function(r,o,c){function s(t){var n=new Parse.Query(e.Post);a&&n.containedIn("category",t),n.count({success:function(n){var c=new Parse.Query(e.Post).skip(r).limit(o).descending("createdAt");a&&c.containedIn("category",t),c.include("user","category"),c.find({success:function(e){var t=[];e.forEach(function(e){t.push({id:e.id,createdAt:e.createdAt,user:e.get("user").get("username"),title:e.get("title"),image:e.get("image"),category:e.get("category").get("name"),content:e.get("content").replace(/<[^>]*>/g,"").replace(/\n/g," ")})}),u.resolve({count:n,posts:t})},error:function(e){u.reject(e)}})},error:function(e){u.reject(e)}})}var a;$.each(n,function(e){return c===e&&n[e].length>1?(c=e,a=n[e],!1):void 0}),!a&&c&&(a=[c]);var u=t.defer();if(a){var i=new Parse.Query(e.Category);i.containedIn("name",a),i.find({success:function(e){var t=[];e.forEach(function(e){t.push({__type:"Pointer",className:"Category",objectId:e.id})}),s(t)}})}else s(null);return u.promise},getPost:function(n){var o=t.defer(),c=new Parse.Query(e.Post);return c.include("user","category","tags"),c.get(n,{success:function(t){var c=t.get("image"),s=c.replace("_big_","_verybig_"),a=t.get("category").get("name"),u=function(e,t){var r=new Image;r.onload=function(){t(!0)},r.onerror=function(){t(!1)},r.src=e};u(s,function(u){var i=new Parse.Query(e.Comment);i.equalTo("post",{__type:"Pointer",className:"Post",objectId:n}),i.count({success:function(e){o.resolve({comments:e,createdAt:t.createdAt,user:t.get("user").get("username"),title:t.get("title"),image:u?s:c,category:a,categoryLink:a.toLowerCase().replace(/ /g,"_"),content:r.trustAsHtml(t.get("content")),tags:$.map(t.get("tags"),function(e){return e.get("name")})})},error:function(e){o.reject(e)}})})},error:function(e){o.reject(e)}}),o.promise},getByTag:function(r,n,o){var c=t.defer(),s=new Parse.Query(e.Tag);return s.equalTo("name",o),s.first({success:function(t){var o=new Parse.Query(e.Post);o.equalTo("tags",{__type:"Pointer",className:"Tag",objectId:t.id}),o.count({success:function(o){var s=new Parse.Query(e.Post).skip(r).limit(n).descending("createdAt");s.equalTo("tags",{__type:"Pointer",className:"Tag",objectId:t.id}),s.include("user","category"),s.find({success:function(e){var t=[];e.forEach(function(e){t.push({id:e.id,createdAt:e.createdAt,user:e.get("user").get("username"),title:e.get("title"),image:e.get("image"),category:e.get("category").get("name"),content:e.get("content").replace(/<[^>]*>/g,"").replace(/\n/g," ")})}),c.resolve({count:o,posts:t})},error:function(e){c.reject(e)}})},error:function(e){c.reject(e)}})},error:function(e){c.reject(e)}}),c.promise},getComments:function(r){var n=t.defer(),c=new Parse.Query(e.Comment);return c.include("user","post","comment"),c.equalTo("post",{__type:"Pointer",className:"Post",objectId:r}),c.find({success:function(e){function t(e){var n=[];return r.forEach(function(r){r.commentId===e&&(r.comments=t(r.id),n.push(r))}),n}var r=[];e.forEach(function(e){var t=e.get("user").get("image"),n=e.get("comment");r.push({id:e.id,createdAt:e.createdAt,content:e.get("content"),username:e.get("user").get("username"),commentId:n?n.id:void 0,avatar:t?t.url():o})});var c=[];r.forEach(function(e){e.commentId||(e.comments=t(e.id),c.push(e))}),n.resolve(c)},error:function(e){n.reject(e)}}),n.promise},addPost:function(t){var r=new Parse.Query(e.Category);r.equalTo("name",t.category),r.first({success:function(r){if(r.get("name")===t.category){var n=new e.Post;n.set("user",Parse.User.current()),n.set("category",r),n.set("title",t.title),n.set("image",t.image),n.set("content",t.content),n.set("tags",[]),n.save({success:function(){e.reloadTo("/")}})}}})},addComment:function(r,n,o){var c=t.defer(),s=new e.Comment;return s.set("user",Parse.User.current()),s.set("content",r),s.set("post",new e.Post({objectId:n})),o&&s.set("comment",new e.Comment({objectId:o})),s.save({success:function(){c.resolve(!0)},error:function(e,t){c.reject(t)}}),c.promise},deleteComment:function(r){var n=t.defer(),o=new Parse.Query(e.Comment);return o.get(r,{success:function(e){e.destroy({success:function(){n.resolve(!0),console.info("comment deleted")},error:function(e){n.reject(e)}})},error:function(e,t){n.reject(t)}}),n.promise},search:function(r,n,o){var c=t.defer(),s=new Parse.Query(e.Post).limit(1e3);return s.matches("content",".*"+o+".*"),s.count({success:function(t){var s=new Parse.Query(e.Post).skip(r).limit(n).descending("createdAt");s.matches("content",".*"+o+".*"),s.include("user","category"),s.find({success:function(e){var r=[];e.forEach(function(e){r.push({id:e.id,createdAt:e.createdAt,user:e.get("user").get("username"),title:e.get("title"),image:e.get("image"),category:e.get("category").get("name"),content:e.get("content").replace(/<[^>]*>/g,"").replace(/\n/g," ")})}),c.resolve({count:t,posts:r})},error:function(e){c.reject(e)}})},error:function(e){c.reject(e)}}),c.promise},getRecentComments:function(r){var n=t.defer(),o=new Parse.Query(e.Comment).limit(r).descending("createdAt");return o.include("user","post"),o.find({success:function(e){var t=[];e.forEach(function(e){var r=e.get("content");t.push({id:e.id,createdAt:e.createdAt,user:e.get("user").get("username"),postId:e.get("post").id,content:r,shortContent:r.slice(0,38)+(r.length>38?"...":"")})}),n.resolve(t)},error:function(e){n.reject(e)}}),n.promise},getRecentPosts:function(r){var n=t.defer(),c=new Parse.Query(e.Post).limit(r).descending("createdAt");return c.include("user","post"),c.find({success:function(e){var t=[];e.forEach(function(e){var r=e.get("title"),n=e.get("user").get("image");t.push({id:e.id,createdAt:e.createdAt,title:r,shortTitle:r.slice(0,38)+(r.length>38?"...":""),user:e.get("user").get("username"),avatar:n?n.url():o})}),n.resolve(t)},error:function(e){n.reject(e)}}),n.promise},getPopularPosts:function(r){var n=t.defer(),c=new Parse.Query(e.Comment).limit(1e3);return c.include("user","post"),c.find({success:function(t){var c={};$.map(t,function(e){var t=e.get("post").id;t in c?c[t]++:c[t]=1});var s=[];$.each(c,function(e){s.push({postId:e,count:c[e]})}),s.sort(function(e,t){return t.count-e.count});var a=s.slice(0,r),u=[];if(a.forEach(function(t){var r=new Parse.Query(e.Post).equalTo("objectId",t.postId);u.push(r)}),u.length>0){var i=Parse.Query.or.apply(this,u);i.include("user","post"),i.find({success:function(e){var t=[];a.forEach(function(r){e.forEach(function(e){if(r.postId===e.id){var n=e.get("title"),c=e.get("user").get("image");return void t.push({id:e.id,createdAt:e.createdAt,title:n,shortTitle:n.slice(0,38)+(n.length>38?"...":""),user:e.get("user").get("username"),avatar:c?c.url():o})}})}),n.resolve(t)},error:function(e){n.reject(e)}})}else n.resolve([])},error:function(e){n.reject(e)}}),n.promise},getRandomPosts:function(r){function n(t){new Parse.Query(e.Post).limit(1e3).skip(t).count().then(function(s){if(1e3!=s){var a=t+s,u=new Parse.Query(e.Post);return u.skip(Math.floor(Math.random()*a+1)).limit(r),u.include("user","post"),void u.find({success:function(e){var t=[];e.forEach(function(e){var r=e.get("user").get("image");t.push({id:e.id,createdAt:e.createdAt,title:e.get("title"),user:e.get("user").get("username"),avatar:r?r.url():o})}),c.resolve(t)},error:function(e){c.reject(e)}})}n(t+s)})}var c=t.defer();return n(0),c.promise},getRelatedPosts:function(r,n,c){var s=t.defer(),a=[];n.slice(0,10).forEach(function(t){var r=new Parse.Query(e.Tag).equalTo("name",t);a.push(r)});var u=Parse.Query.or.apply(this,a);return u.find({success:function(t){var n=[];t.forEach(function(t){var r=new Parse.Query(e.Post);r.equalTo("tags",{__type:"Pointer",className:"Tag",objectId:t.id}),n.push(r)});var a=Parse.Query.or.apply(this,n).limit(c);a.notEqualTo("objectId",r),a.include("user"),a.find({success:function(e){var t=[];e.forEach(function(e){var r=e.get("user").get("image");t.push({id:e.id,createdAt:e.createdAt,title:e.get("title"),user:e.get("user").get("username"),avatar:r?r.url():o})}),s.resolve(t)},error:function(e){s.reject(e)}})},error:function(e){s.reject(e)}}),s.promise}}})}();
!function(){"use strict";newsApp.factory("userData",function(e,r,t,s){return{getUsers:function(r,t){var n=e.defer(),o=new Parse.Query(Parse.User);return o.count({success:function(e){var o=new Parse.Query(Parse.User).skip(r).limit(t).descending("createdAt");o.include("role"),o.find({success:function(r){var t=[];r.forEach(function(e){var r=e.get("image");t.push({username:e.get("username"),createdAt:e.createdAt,avatar:r?r.url():s,gender:e.get("gender"),aboutMe:e.get("aboutMe"),role:e.get("role").get("name")})}),n.resolve({count:e,users:t})},error:function(e){n.reject(e)}})},error:function(e){n.reject(e)}}),n.promise},getUser:function(r){var t=e.defer(),n=new Parse.Query(Parse.User);return n.equalTo("username",r),n.include("role"),n.first({success:function(e){var r=e.get("image");t.resolve({username:e.get("username"),createdAt:e.createdAt,image:r?r.url():s,email:e.get("email"),firstName:e.get("firstName"),lastName:e.get("lastName"),website:e.get("website"),gender:e.get("gender"),aboutMe:e.get("aboutMe"),colorScheme:e.get("colorScheme"),role:e.get("role").get("name")})},error:function(e){t.reject(e)}}),t.promise},getUserRole:function(){var r=e.defer();return t.currentUser.get("role").fetch({success:function(e){r.resolve(e.get("name"))},error:function(e){r.reject(e)}}),r.promise},updateProfile:function(e){if(e.set("firstName",e.firstName),e.set("lastName",e.lastName),e.set("website",e.website),e.set("gender",e.gender),e.set("aboutMe",e.aboutMe),e.set("colorScheme",e.colorScheme),e.showImage.length>1e3){var r=new Parse.File(e.id+".jpg",{base64:e.image});r.save().then(function(r){e.set("image",r),e.save({success:function(){t.statusUpdate(),t.statusUpdate()},error:function(e,r){console.info(r)}})})}else e.save({success:function(){t.statusUpdate(),t.statusUpdate()},error:function(e){console.info(e)}})},deleteProfile:function(){confirm("Your profile will be permanently deleted and cannot be recovered. Are you sure?")?Parse.User.current().destroy({success:function(){console.info("deleted"),t.logout()},error:function(e){console.info(e)}}):console.log("not deleted")}}})}();
!function(){"use strict";newsApp.directive("fileReader",function(e,n){return{restrict:"A",require:"ngModel",link:function(t,r,i,a){r.bind("change",function(t){function r(){var n=e.defer(),r=new FileReader;return r.onload=function(e){n.resolve(e.target.result)},r.readAsDataURL(t.target.files[0]),n.promise}r().then(function(e){a.$setViewValue(e),n.profileImageUpdate()})})}}})}();
!function(){"use strict";newsApp.directive("showReply",function(e){return{restrict:"A",link:function(n){n.showReplyLink=++n.commentLevel<e}}})}();