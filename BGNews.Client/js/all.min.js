var newsApp=angular.module("newsApp",["ngRoute","ui.bootstrap"]);!function(){"use strict";newsApp.config(function(e,t){t.html5Mode(!0),e.when("/",{title:"Home",templateUrl:"templates/collection.html",controller:"PostsController"}).when("/category/:categoryName",{templateUrl:"templates/collection.html",controller:"PostsController"}).when("/search/:word",{title:"Search",templateUrl:"templates/collection.html",controller:"SearchController"}).when("/tags/:tag",{templateUrl:"templates/collection.html",controller:"TagsController"}).when("/post/:postId",{templateUrl:"templates/post.html",controller:"PostController"}).when("/login",{title:"Login",templateUrl:"templates/login.html"}).when("/signup",{title:"Signup",templateUrl:"templates/signup.html"}).when("/users",{title:"Users",templateUrl:"templates/collection.html",controller:"UsersController"}).when("/profile",{title:"Profile",templateUrl:"templates/profile.html",controller:"ProfileController"}).when("/users/:username",{templateUrl:"templates/user.html",controller:"UserController"}).when("/new-post",{title:"New Post",templateUrl:"templates/add-post.html",controller:"AddPostController"}).when("/help",{title:"Help",templateUrl:"templates/help.html"}).otherwise({redirectTo:"/"})}).constant("ITEMS_PER_PAGE",6).constant("LEVEL_OF_NESTED_COMMENTS",3).constant("DEFAULT_IMAGE","http://s15.postimg.org/j9x15yxxj/user.jpg").constant("SCHEME_COLORS",["Black","Brown","Gray","Red","Turquoise"]).constant("CATEGORIES",{Business:["Finance","Energy","Industry","Properties","Tourism"],Politics:["Diplomacy","Defense","Bulgaria in EU","Domestic"],World:["EU","Southeast Europe","Russia","Ukraine","International Business"],Society:["Environment","Education","Culture","Health","Incidents"],Sports:["Sports"],Crime:["Crime"]}).run(["$rootScope",function(e){Parse.initialize("U3XywIHqzfU4KD8FEV57PRmMZPpmuDOwflN6itSy","PA0TnuPtd3ktVSscE4BECVlYr7y7TPNRfxGRe5eb"),e.Post=Parse.Object.extend("Post"),e.Comment=Parse.Object.extend("Comment"),e.Category=Parse.Object.extend("Category"),e.Tag=Parse.Object.extend("Tag"),e.$on("$routeChangeSuccess",function(t,l){e.title=l.title})}])}();
!function(){"use strict";newsApp.controller("AddPostController",function(n,t,o){n.currentUser&&"Administrator"===n.currentUser.role?(t.isAdmin=!0,t.addPost=function(n){o.addPost(n)},t.cancel=function(){n.navigateTo("/")}):(t.isAdmin=!1,n.navigateTo("/"))})}();
!function(){"use strict";newsApp.controller("PageController",function(e,r,s,t,c,n){t.navigateTo=function(e){r.location.assign(e)},t.login=function(e){Parse.User.logIn(e.username,e.password,{success:function(){t.statusUpdate(),t.navigateTo("/")},error:function(e,r){console.log("Error: "+r.code+" "+r.message)}})},t.signup=function(e){var r="2IPQes1NcD",s=new Parse.User;s.set("username",e.username),s.set("password",e.password),s.set("email",e.email),s.set("colorScheme","Black"),s.set("role",{__type:"Pointer",className:"_Role",objectId:r}),s.signUp(null,{success:function(){t.navigateTo("/profile")},error:function(e,r){console.log("Error: "+r.code+" "+r.message)}})},t.logout=function(){Parse.User.logOut(),t.statusUpdate(),t.navigateTo("/")},t.profileImageUpdate=function(){t.currentUser.showImage&&t.currentUser.showImage!=t.currentUser.image?t.currentUser.showImage=t.currentUser.image:t.currentUser.image?t.currentUser.showImage=t.currentUser.image.url():t.currentUser.showImage=n},t.statusUpdate=function(){t.currentUser=Parse.User.current(),t.currentUser?c.getUserRole().then(function(e){t.currentUser.role=e,t.currentUser.username=t.currentUser.get("username"),t.currentUser.email=t.currentUser.get("email"),t.currentUser.firstName=t.currentUser.get("firstName"),t.currentUser.lastName=t.currentUser.get("lastName"),t.currentUser.website=t.currentUser.get("website"),t.currentUser.gender=t.currentUser.get("gender"),t.currentUser.aboutMe=t.currentUser.get("aboutMe"),t.currentUser.colorScheme=t.currentUser.get("colorScheme"),t.currentUser.image=t.currentUser.get("image"),t.profileImageUpdate(),t.colorSchemeUpdate()}):t.colorSchemeUpdate()},t.colorSchemeUpdate=function(){switch(t.currentUser?t.currentUser.colorScheme:void 0){default:t.csHtml="cs-html-black";break;case"Brown":t.csHtml="cs-html-brown";break;case"Gray":t.csHtml="cs-html-gray";break;case"Red":t.csHtml="cs-html-red";break;case"Turquoise":t.csHtml="cs-html-turquoise"}},t.statusUpdate()})}();
!function(){"use strict";newsApp.controller("PostController",function(t,o,n,e){t.replyToPost=!0,t.getAllComments=function(){e.getComments(o.postId).then(function(o){t.comments=o})},t.replyTo=function(o){function n(t){$.map(t.comments,function(t){t.showReply=t.id===o,n(t)})}t.replyToCommentId=o,t.replyToPost=!1,n(t)},t.addComment=function(n){e.addComment(n,o.postId,t.replyToCommentId).then(function(o){o&&(t.getAllComments(),t.replyToPost=!0,t.replyToCommentId=void 0,t.newComment="")})},t.deleteComment=function(o){e.deleteComment(o).then(function(o){o&&t.getAllComments()})},e.getPost(o.postId).then(function(o){n.title=o.title,t.post=o,t.getAllComments()})})}();
!function(){"use strict";newsApp.controller("PostsController",function(e,t,o,r,n,a){e.itemsPerPage=a,e.isUser=!1,e.isPost=!0,e.currentPage=1,e.pages=5,e.getPage=function(){var s=(e.currentPage-1)*a,c=t.categoryName;c?(c=c.replace(/_/g," "),e.isHome=!0):e.isHome=!1;var i=function(){var e;return c&&$.each(n,function(t){return t.toLowerCase()===c.toLowerCase()?(e=t,!1):void $.each(n[t],function(o){var r=n[t][o];return r.toLowerCase()===c.toLowerCase()?(e=r,!1):void 0})}),e};c=i(),r.getCategory(s,a,c).then(function(t){e.collection=t.posts,e.totalItems=t.count,c&&(o.title=c)})},e.getPage()})}();
!function(){"use strict";newsApp.controller("ProfileController",function(e,o,r,l){o.currentUser?(e.isLogged=!0,e.hello="Hello "+o.currentUser.username,e.colors=l,e.updateProfile=function(e){r.updateProfile(e)},e.deleteProfile=function(){r.deleteProfile()}):(e.isLogged=!1,o.navigateTo("/"))})}();
!function(){"use strict";newsApp.controller("SearchController",function(e,t,n,o){e.itemsPerPage=o,e.isPost=!0,e.isUser=!1,e.currentPage=1,e.pages=5,e.getPage=function(){var r=(e.currentPage-1)*o;n.search(r,o,t.word).then(function(t){e.collection=t.posts,e.totalItems=t.count}),e.isHome=!0},e.getPage()})}();
!function(){"use strict";newsApp.controller("TagsController",function(t,e,n,o,g){n.title="Tag "+e.tag,t.itemsPerPage=g,t.isPost=!0,t.isUser=!1,t.currentPage=1,t.pages=5,t.getPage=function(){var n=(t.currentPage-1)*g;o.getByTag(n,g,e.tag).then(function(e){t.collection=e.posts,t.totalItems=e.count}),t.isHome=!0},t.getPage()})}();
!function(){"use strict";newsApp.controller("UserController",function(e,n,t,r){t.title=n.username,r.getUser(n.username).then(function(n){e.user=n})})}();
!function(){"use strict";newsApp.controller("UsersController",function(e,t,s){e.itemsPerPage=s,e.isPost=!1,e.isUser=!0,e.currentPage=1,e.pages=5,e.getPage=function(){var n=(e.currentPage-1)*s;t.getUsers(n,s).then(function(t){e.collection=t.users,e.totalItems=t.count}),e.isHome=!0},e.getPage()})}();
!function(){"use strict";newsApp.directive("addComment",function(){return{restrict:"A",templateUrl:"/templates/directives/add-comment.html",replace:!1}})}();
!function(){"use strict";newsApp.directive("postThumbnail",function(){return{restrict:"A",templateUrl:"/templates/directives/post-thumbnail.html",replace:!1}})}();
!function(){"use strict";newsApp.directive("userThumbnail",function(){return{restrict:"A",templateUrl:"/templates/directives/user-thumbnail.html",replace:!1}})}();
!function(){"use strict";newsApp.factory("postData",function(e,t,r,n,o){return{getCategory:function(o,s,c){function a(t){var n=new Parse.Query(e.Post);u&&n.containedIn("category",t),n.count({success:function(n){var c=new Parse.Query(e.Post).skip(o).limit(s).descending("createdAt");u&&c.containedIn("category",t),c.include("user","category"),c.find({success:function(e){var t=[];e.forEach(function(e){t.push({id:e.id,createdAt:e.createdAt,user:e.get("user").get("username"),title:e.get("title"),image:e.get("image"),category:e.get("category").get("name"),content:r.trustAsHtml(e.get("content"))})}),i.resolve({count:n,posts:t})},error:function(e){i.reject(e)}})},error:function(e){i.reject(e)}})}var u;$.each(n,function(e){return c===e&&n[e].length>1?(c=e,u=n[e],!1):void 0}),!u&&c&&(u=[c]);var i=t.defer();if(u){var f=new Parse.Query(e.Category);f.containedIn("name",u),f.find({success:function(e){var t=[];e.forEach(function(e){t.push({__type:"Pointer",className:"Category",objectId:e.id})}),a(t)}})}else a(null);return i.promise},getPost:function(n){var o=t.defer(),s=new Parse.Query(e.Post);return s.include("user","category","tags"),s.get(n,{success:function(e){var t=e.get("image"),n=t.replace("_big_","_verybig_"),s=e.get("category").get("name"),c=function(e,t){var r=new Image;r.onload=function(){t(!0)},r.onerror=function(){t(!1)},r.src=e};c(n,function(c){o.resolve({createdAt:e.createdAt,user:e.get("user").get("username"),title:e.get("title"),image:c?n:t,category:s,categoryLink:s.toLowerCase().replace(/ /g,"_"),content:r.trustAsHtml(e.get("content")),tags:$.map(e.get("tags"),function(e){return e.get("name")})})})},error:function(e){o.reject(e)}}),o.promise},getByTag:function(n,o,s){var c=t.defer(),a=new Parse.Query(e.Tag);return a.equalTo("name",s),a.first({success:function(t){var s=new Parse.Query(e.Post);s.equalTo("tags",{__type:"Pointer",className:"Tag",objectId:t.id}),s.count({success:function(s){var a=new Parse.Query(e.Post).skip(n).limit(o).descending("createdAt");a.equalTo("tags",{__type:"Pointer",className:"Tag",objectId:t.id}),a.include("user","category"),a.find({success:function(e){var t=[];e.forEach(function(e){t.push({id:e.id,createdAt:e.createdAt,user:e.get("user").get("username"),title:e.get("title"),image:e.get("image"),category:e.get("category").get("name"),content:r.trustAsHtml(e.get("content"))})}),c.resolve({count:s,posts:t})},error:function(e){c.reject(e)}})},error:function(e){c.reject(e)}})},error:function(e){c.reject(e)}}),c.promise},getComments:function(r){var n=t.defer(),s=new Parse.Query(e.Comment);return s.include("user","post","comment"),s.equalTo("post",{__type:"Pointer",className:"Post",objectId:r}),s.find({success:function(e){function t(e){var n=[];return r.forEach(function(r){r.commentId===e&&(r.comments=t(r.id),n.push(r))}),n}var r=[];e.forEach(function(e){var t=e.get("user").get("image"),n=e.get("comment");r.push({id:e.id,createdAt:e.createdAt,content:e.get("content"),username:e.get("user").get("username"),commentId:n?n.id:void 0,avatar:t?t.url():o})});var s=[];r.forEach(function(e){e.commentId||(e.comments=t(e.id),s.push(e))}),n.resolve(s)},error:function(e){n.reject(e)}}),n.promise},addPost:function(t){var r=new Parse.Query(e.Category);r.equalTo("name",t.category),r.first({success:function(r){if(r.get("name")===t.category){var n=new e.Post;n.set("user",Parse.User.current()),n.set("category",r),n.set("title",t.title),n.set("image",t.image),n.set("content",t.content),n.set("tags",[]),n.save({success:function(){e.navigateTo("/")}})}}})},addComment:function(r,n,o){var s=t.defer(),c=new e.Comment;return c.set("user",Parse.User.current()),c.set("content",r),c.set("post",new e.Post({objectId:n})),o&&c.set("comment",new e.Comment({objectId:o})),c.save({success:function(){s.resolve(!0)},error:function(e,t){s.reject(t)}}),s.promise},deleteComment:function(r){var n=t.defer(),o=new Parse.Query(e.Comment);return o.get(r,{success:function(e){e.destroy({success:function(){n.resolve(!0),console.info("comment deleted")},error:function(e){n.reject(e)}})},error:function(e,t){n.reject(t)}}),n.promise},search:function(n,o,s){var c=t.defer(),a=new Parse.Query(e.Post).limit(1e3);return a.matches("content",".*"+s+".*"),a.count({success:function(t){var a=new Parse.Query(e.Post).skip(n).limit(o).descending("createdAt");a.matches("content",".*"+s+".*"),a.include("user","category"),a.find({success:function(e){var n=[];e.forEach(function(e){n.push({id:e.id,createdAt:e.createdAt,user:e.get("user").get("username"),title:e.get("title"),image:e.get("image"),category:e.get("category").get("name"),content:r.trustAsHtml(e.get("content"))})}),c.resolve({count:t,posts:n})},error:function(e){c.reject(e)}})},error:function(e){c.reject(e)}}),c.promise},getRecentComments:function(r){var n=t.defer(),o=new Parse.Query(e.Comment).limit(r).descending("createdAt");return o.include("user","post"),o.find({success:function(e){var t=[];e.forEach(function(e){t.push({id:e.id,createdAt:e.createdAt,user:e.get("user").get("username"),postId:e.get("post").id,content:e.get("content")})}),n.resolve(t)},error:function(e){n.reject(e)}}),n.promise},getRecentPosts:function(r){var n=t.defer(),s=new Parse.Query(e.Post).limit(r).descending("createdAt");return s.include("user","post"),s.find({success:function(e){var t=[];e.forEach(function(e){var r=e.get("user").get("image");t.push({id:e.id,createdAt:e.createdAt,title:e.get("title"),user:e.get("user").get("username"),avatar:r?r.url():o})}),n.resolve(t)},error:function(e){n.reject(e)}}),n.promise},getPopularPosts:function(r){var n=t.defer(),s=new Parse.Query(e.Comment).limit(1e3);return s.include("user","post"),s.find({success:function(t){var s={};$.map(t,function(e){var t=e.get("post").id;t in s?s[t]++:s[t]=1});var c=[];$.each(s,function(e){c.push({postId:e,count:s[e]})}),console.warn(c),c.sort(function(e,t){return t.count-e.count});var a=c.slice(0,r),u=[];if(a.forEach(function(t){var r=new Parse.Query(e.Post).equalTo("objectId",t.postId);u.push(r)}),u.length>0){var i=Parse.Query.or.apply(this,u);i.include("user","post"),i.find({success:function(e){var t=[];a.forEach(function(r){e.forEach(function(e){if(r.postId===e.id){var n=e.get("user").get("image");return void t.push({id:e.id,createdAt:e.createdAt,title:e.get("title"),user:e.get("user").get("username"),avatar:n?n.url():o})}})}),n.resolve(t)},error:function(e){n.reject(e)}})}else n.resolve([])},error:function(e){n.reject(e)}}),n.promise},getRandomPosts:function(r){function n(t){new Parse.Query(e.Post).limit(1e3).skip(t).count().then(function(c){if(1e3!=c){var a=t+c,u=new Parse.Query(e.Post);return u.skip(Math.floor(Math.random()*a+1)).limit(r),u.include("user","post"),void u.find({success:function(e){var t=[];e.forEach(function(e){var r=e.get("user").get("image");t.push({id:e.id,createdAt:e.createdAt,title:e.get("title"),user:e.get("user").get("username"),avatar:r?r.url():o})}),s.resolve(t)},error:function(e){s.reject(e)}})}n(t+c)})}var s=t.defer();return n(0),s.promise},getRelatedPosts:function(r,n){var s=t.defer(),c=[];r.forEach(function(t){var r=new Parse.Query(e.Tag).equalTo("name",t);c.push(r)});var a=Parse.Query.or.apply(this,c);return a.find({success:function(t){var r=[];t.forEach(function(t){var n=new Parse.Query(e.Post);n.equalTo("tags",{__type:"Pointer",className:"Tag",objectId:t.id}),r.push(n)});var c=Parse.Query.or.apply(this,r).limit(n);c.include("user","post"),c.find({success:function(e){var t=[];e.forEach(function(e){var r=e.get("user").get("image");t.push({id:e.id,createdAt:e.createdAt,title:e.get("title"),user:e.get("user").get("username"),avatar:r?r.url():o})}),s.resolve(t)},error:function(e){s.reject(e)}})},error:function(e){s.reject(e)}}),s.promise}}})}();
!function(){"use strict";newsApp.factory("userData",function(e,r,t,s){return{getUsers:function(r,t){var n=e.defer(),o=new Parse.Query(Parse.User);return o.count({success:function(e){var o=new Parse.Query(Parse.User).skip(r).limit(t).descending("createdAt");o.include("role"),o.find({success:function(r){var t=[];r.forEach(function(e){var r=e.get("image");t.push({username:e.get("username"),createdAt:e.createdAt,avatar:r?r.url():s,gender:e.get("gender"),aboutMe:e.get("aboutMe"),role:e.get("role").get("name")})}),n.resolve({count:e,users:t})},error:function(e){n.reject(e)}})},error:function(e){n.reject(e)}}),n.promise},getUser:function(r){var t=e.defer(),n=new Parse.Query(Parse.User);return n.equalTo("username",r),n.include("role"),n.first({success:function(e){var r=e.get("image");t.resolve({username:e.get("username"),createdAt:e.createdAt,image:r?r.url():s,email:e.get("email"),firstName:e.get("firstName"),lastName:e.get("lastName"),website:e.get("website"),gender:e.get("gender"),aboutMe:e.get("aboutMe"),colorScheme:e.get("colorScheme"),role:e.get("role").get("name")})},error:function(e){t.reject(e)}}),t.promise},getUserRole:function(){var r=e.defer();return t.currentUser.get("role").fetch({success:function(e){r.resolve(e.get("name"))},error:function(e){r.reject(e)}}),r.promise},updateProfile:function(e){if(e.set("firstName",e.firstName),e.set("lastName",e.lastName),e.set("website",e.website),e.set("gender",e.gender),e.set("aboutMe",e.aboutMe),e.set("colorScheme",e.colorScheme),e.showImage.length>1e4){var r=new Parse.File(e.id+".jpg",{base64:e.image});r.save().then(function(r){e.set("image",r),e.save({success:function(){t.statusUpdate(),t.statusUpdate()},error:function(e,r){console.info(r)}})})}else e.save({success:function(){t.statusUpdate(),t.statusUpdate()},error:function(e){console.info(e)}})},deleteProfile:function(){confirm("Your profile will be permanently deleted and cannot be recovered. Are you sure?")?Parse.User.current().destroy({success:function(){console.info("deleted"),t.logout()},error:function(e){console.info(e)}}):console.log("not deleted")}}})}();
!function(){"use strict";newsApp.directive("fileReader",function(e,n){return{restrict:"A",require:"ngModel",link:function(t,r,i,a){r.bind("change",function(t){function r(){var n=e.defer(),r=new FileReader;return r.onload=function(e){n.resolve(e.target.result)},r.readAsDataURL(t.target.files[0]),n.promise}r().then(function(e){a.$setViewValue(e),n.profileImageUpdate()})})}}})}();
!function(){"use strict";newsApp.directive("showReply",function(e){return{restrict:"A",link:function(n){n.showReplyLink=++n.commentLevel<e}}})}();